# AOF Notification Rules Configuration
# Version: 1
#
# Rules are evaluated first-match-wins.
# Payload matchers must appear BEFORE generic eventType rules for the same type.
#
# Template tokens: {taskId}, {actor}, {payload.field}, {payload.nested.field}
#
# Severity tiers:
#   info     â€” routine lifecycle events (5-min dedupe)
#   warn     â€” attention needed (5-min dedupe, 15-min for SLA)
#   critical â€” urgent/unsuppressable (neverSuppress: true bypasses dedupe)

version: 1

defaults:
  dedupeWindowMs: 300000        # 5 minutes
  criticalNeverSuppressed: true

rules:
  # â”€â”€ Task lifecycle â€” specific transitions (before generic) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  - match:
      eventType: "task.transitioned"
      payload:
        to: "review"
    severity: warn
    audience: [team-lead, operator]
    channel: "#aof-review"
    template: "ğŸ‘€ {taskId} ready for review (by {actor})"
    dedupeWindowMs: 0           # Always send â€” review needs immediate attention

  - match:
      eventType: "task.transitioned"
      payload:
        to: "blocked"
    severity: warn
    audience: [team-lead, operator]
    channel: "#aof-alerts"
    template: "ğŸš§ {taskId} blocked: {payload.reason}"

  - match:
      eventType: "task.transitioned"
      payload:
        to: "done"
    severity: info
    audience: [agent, team-lead]
    channel: "#aof-dispatch"
    template: "âœ… {actor} completed {taskId}"

  - match:
      eventType: "task.transitioned"
      payload:
        to: "in-progress"
    severity: info
    audience: [agent]
    channel: "#aof-dispatch"
    template: "â–¶ï¸ {actor} started {taskId}"

  - match:
      eventType: "task.transitioned"
    severity: info
    audience: [agent]
    channel: "#aof-dispatch"
    template: "ğŸ”„ {taskId}: {payload.from} â†’ {payload.to}"

  # â”€â”€ Task lifecycle â€” generic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  - match:
      eventType: "task.created"
    severity: info
    audience: [agent]
    channel: "#aof-dispatch"
    template: "ğŸ“¬ Task {taskId} created: {payload.title}"

  - match:
      eventType: "task.blocked"
    severity: warn
    audience: [team-lead, operator]
    channel: "#aof-alerts"
    template: "ğŸš§ {taskId} blocked: {payload.reason}"

  - match:
      eventType: "task.deadletter"
    severity: critical
    audience: [operator]
    channel: "#aof-alerts"
    template: "ğŸª¦ Task {taskId} moved to dead letter: {payload.reason}"
    neverSuppress: true

  - match:
      eventType: "task.abandoned"
    severity: critical
    audience: [operator]
    channel: "#aof-alerts"
    template: "ğŸ’€ Task {taskId} may be abandoned (check run.json)"
    neverSuppress: true

  - match:
      eventType: "task.resurrected"
    severity: info
    audience: [team-lead]
    channel: "#aof-dispatch"
    template: "ğŸ” Task {taskId} resurrected"

  - match:
      eventType: "task.dep.added"
    severity: info
    audience: [agent]
    channel: "#aof-dispatch"
    template: "ğŸ”— Dependency added to {taskId}: {payload.depId}"

  - match:
      eventType: "task.dep.removed"
    severity: info
    audience: [agent]
    channel: "#aof-dispatch"
    template: "âœ‚ï¸ Dependency removed from {taskId}: {payload.depId}"

  # â”€â”€ Dependency cascade â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  - match:
      eventType: "dependency.cascaded"
      payload:
        action: "promote"
    severity: info
    audience: [operator]
    channel: "#aof-dispatch"
    template: "ğŸ”— Cascade: {payload.count} task(s) promoted after {payload.trigger} completed"
    dedupeWindowMs: 30000

  - match:
      eventType: "dependency.cascaded"
      payload:
        action: "block"
    severity: warn
    audience: [team-lead, operator]
    channel: "#aof-alerts"
    template: "ğŸš§ Cascade block: {payload.count} task(s) blocked â€” upstream {payload.trigger} is blocked"
    dedupeWindowMs: 0

  # â”€â”€ Lease management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  - match:
      eventType: "lease.expired"
    severity: warn
    audience: [team-lead]
    channel: "#aof-alerts"
    template: "â° Lease expired on {taskId} (agent: {actor})"

  # â”€â”€ SLA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  - match:
      eventType: "sla.violation"
    severity: warn
    audience: [team-lead]
    channel: "#aof-alerts"
    template: "âš ï¸ SLA violation: {taskId} in-progress {payload.durationHrs}h (limit: {payload.limitHrs}h)"
    dedupeWindowMs: 900000      # 15 min â€” matches SlaChecker rate limiter

  # â”€â”€ Gate events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  - match:
      eventType: "gate_timeout"
    severity: warn
    audience: [team-lead]
    channel: "#aof-alerts"
    template: "â±ï¸ Gate timeout: {taskId} ({payload.gate})"

  - match:
      eventType: "gate_timeout_escalation"
    severity: critical
    audience: [operator]
    channel: "#aof-critical"
    template: "ğŸ”´ Gate escalation: {taskId} escalated after {payload.elapsed}h"
    neverSuppress: true

  # â”€â”€ System events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  - match:
      eventType: "system.drift-detected"
    severity: warn
    audience: [operator]
    channel: "#aof-alerts"
    template: "âš ï¸ Org chart drift: {payload.summary}"

  - match:
      eventType: "system.config-changed"
    severity: info
    audience: [operator]
    channel: "#aof-alerts"
    template: "ğŸ”§ Config changed: {payload.key}"

  - match:
      eventType: "system.shutdown"
    severity: critical
    audience: [operator]
    channel: "#aof-critical"
    template: "ğŸ”´ AOF system shutting down"
    neverSuppress: true

  - match:
      eventType: "system.recovery"
    severity: warn
    audience: [operator]
    channel: "#aof-alerts"
    template: "ğŸŸ¢ Scheduler recovered"

  - match:
      eventType: "system.startup"
    severity: info
    audience: [operator]
    channel: "#aof-alerts"
    template: "ğŸŸ¢ AOF system started"

  # â”€â”€ Scheduler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  - match:
      eventType: "scheduler_alert"
    severity: warn
    audience: [operator]
    channel: "#aof-alerts"
    template: "ğŸ”” Scheduler alert: {payload.reason}"

  # â”€â”€ Concurrency â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  - match:
      eventType: "concurrency.platformLimit"
    severity: warn
    audience: [operator]
    channel: "#aof-alerts"
    template: "ğŸš¦ Platform concurrency limit reached ({payload.current}/{payload.limit})"

  # â”€â”€ Murmur events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  - match:
      eventType: "murmur.review.dispatched"
    severity: info
    audience: [team-lead]
    channel: "#aof-dispatch"
    template: "ğŸ” Murmur review dispatched: {payload.taskTitle}"

  - match:
      eventType: "murmur.review.dispatch_failed"
    severity: warn
    audience: [operator]
    channel: "#aof-alerts"
    template: "âš ï¸ Murmur dispatch failed: {payload.error}"

  - match:
      eventType: "murmur.review.dispatch_error"
    severity: warn
    audience: [operator]
    channel: "#aof-alerts"
    template: "âš ï¸ Murmur dispatch error: {payload.error}"

  - match:
      eventType: "murmur.evaluation.error"
    severity: warn
    audience: [operator]
    channel: "#aof-alerts"
    template: "âš ï¸ Murmur evaluation error: {payload.error}"

  - match:
      eventType: "murmur.evaluation.failed"
    severity: warn
    audience: [operator]
    channel: "#aof-alerts"
    template: "âš ï¸ Murmur evaluation failed: {payload.error}"
